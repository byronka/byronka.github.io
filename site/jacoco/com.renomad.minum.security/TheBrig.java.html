<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TheBrig.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">minum</a> &gt; <a href="index.source.html" class="el_package">com.renomad.minum.security</a> &gt; <span class="el_source">TheBrig.java</span></div><h1>TheBrig.java</h1><pre class="source lang-java linenums">package com.renomad.minum.security;

import com.renomad.minum.database.AbstractDb;
import com.renomad.minum.state.Context;
import com.renomad.minum.logging.ILogger;
import com.renomad.minum.utils.ThrowingRunnable;
import com.renomad.minum.utils.TimeUtils;

import java.util.*;
import java.util.concurrent.*;
import java.util.concurrent.locks.ReentrantLock;

/**
 * See {@link ITheBrig}
 */
public final class TheBrig implements ITheBrig {
    private final ExecutorService es;
    private final AbstractDb&lt;Inmate&gt; inmatesDb;
    private final ILogger logger;
<span class="fc" id="L20">    private final ReentrantLock lock = new ReentrantLock();</span>
    private Thread myThread;
    private static final String CLIENT_IDENTIFIER_INDEX = &quot;client_identifier_index&quot;;

    /**
     * How long our inner thread will sleep before waking up to scan
     * for old keys
     */
    private final int sleepTime;

<span class="fc" id="L30">    public TheBrig(int sleepTime, Context context) {</span>
<span class="fc" id="L31">        this.es = context.getExecutorService();</span>
<span class="fc" id="L32">        this.logger = context.getLogger();</span>
<span class="fc" id="L33">        this.inmatesDb = context.getDb2(&quot;the_brig&quot;, Inmate.EMPTY);</span>
<span class="fc" id="L34">        this.inmatesDb.registerIndex(CLIENT_IDENTIFIER_INDEX, Inmate::getClientId);</span>
<span class="fc" id="L35">        this.sleepTime = sleepTime;</span>
<span class="fc" id="L36">    }</span>

    /**
     * In this class we create a thread that runs throughout the lifetime
     * of the application, in an infinite loop removing keys from the list
     * under consideration.
     */
    public TheBrig(Context context) {
<span class="fc" id="L44">        this(10 * 1000, context);</span>
<span class="fc" id="L45">    }</span>

    // Regarding the BusyWait - indeed, we expect that the while loop
    // below is an infinite loop unless there's an exception thrown, that's what it is.
    @Override
    public ITheBrig initialize() {
<span class="fc" id="L51">        logger.logDebug(() -&gt; &quot;Initializing TheBrig main loop&quot;);</span>
<span class="fc" id="L52">        ThrowingRunnable innerLoopThread = () -&gt; {</span>
<span class="fc" id="L53">            Thread.currentThread().setName(&quot;TheBrigThread&quot;);</span>
<span class="fc" id="L54">            myThread = Thread.currentThread();</span>
            while (true) {
                try {
<span class="fc" id="L57">                    reviewCurrentInmates();</span>
<span class="fc" id="L58">                } catch (InterruptedException ex) {</span>

                    /*
                    this is what we expect to happen.
                    once this happens, we just continue on.
                    this only gets called when we are trying to shut everything
                    down cleanly
                     */

<span class="fc" id="L67">                    logger.logDebug(() -&gt; String.format(&quot;%s TheBrig is stopped.%n&quot;, TimeUtils.getTimestampIsoInstant()));</span>
<span class="fc" id="L68">                    Thread.currentThread().interrupt();</span>
<span class="fc" id="L69">                    break;</span>
<span class="fc" id="L70">                }</span>
            }
<span class="fc" id="L72">        };</span>
<span class="fc" id="L73">        es.submit(ThrowingRunnable.throwingRunnableWrapper(innerLoopThread, logger));</span>
<span class="fc" id="L74">        return this;</span>
    }

    private void reviewCurrentInmates() throws InterruptedException {
<span class="fc" id="L78">        Collection&lt;Inmate&gt; values = inmatesDb.values();</span>
<span class="fc bfc" id="L79" title="All 2 branches covered.">        if (! values.isEmpty()) {</span>
<span class="fc" id="L80">            logger.logTrace(() -&gt; &quot;TheBrig reviewing current inmates. Count: &quot; + values.size());</span>
        }
<span class="fc" id="L82">        var now = System.currentTimeMillis();</span>
<span class="fc" id="L83">        lock.lock();</span>
        try {
<span class="fc" id="L85">            processInmateList(now, values, logger, inmatesDb);</span>
        } finally {
<span class="fc" id="L87">            lock.unlock();</span>
        }
<span class="fc" id="L89">        Thread.sleep(sleepTime);</span>
<span class="fc" id="L90">    }</span>

    /**
     * figure out which clients have paid their dues
     * @param now the current time, in milliseconds past the epoch
     * @param inmatesDb the database of all inmates
     */
    static void processInmateList(long now, Collection&lt;Inmate&gt; inmates, ILogger logger, AbstractDb&lt;Inmate&gt; inmatesDb) {
<span class="fc bfc" id="L98" title="All 2 branches covered.">        for (Inmate clientKeyAndDuration : inmates) {</span>
            // if the release time is in the past (that is, the release time is
            // before / less-than now), add them to the list to be released.
<span class="fc bfc" id="L101" title="All 2 branches covered.">            if (clientKeyAndDuration.getReleaseTime() &lt; now) {</span>
<span class="fc" id="L102">                logger.logTrace(() -&gt; &quot;UnderInvestigation: &quot; + clientKeyAndDuration.getClientId() + &quot; has paid its dues as of &quot; + clientKeyAndDuration.getReleaseTime() + &quot; and is getting released. Current time: &quot; + now);</span>
<span class="fc" id="L103">                inmatesDb.delete(clientKeyAndDuration);</span>
            }
<span class="fc" id="L105">        }</span>
<span class="fc" id="L106">    }</span>

    @Override
    public void stop() {
<span class="fc" id="L110">        logger.logDebug(() -&gt; &quot;TheBrig has been told to stop&quot;);</span>
<span class="fc bfc" id="L111" title="All 2 branches covered.">        if (myThread != null) {</span>
<span class="fc" id="L112">            logger.logDebug(() -&gt; &quot;TheBrig: Sending interrupt to thread&quot;);</span>
<span class="fc" id="L113">            myThread.interrupt();</span>
<span class="fc" id="L114">            this.inmatesDb.stop();</span>
        } else {
<span class="fc" id="L116">            throw new MinumSecurityException(&quot;TheBrig was told to stop, but it was uninitialized&quot;);</span>
        }
<span class="fc" id="L118">    }</span>

    @Override
    public boolean sendToJail(String clientIdentifier, long sentenceDuration) {
<span class="fc" id="L122">        lock.lock(); // block threads here if multiple are trying to get in - only one gets in at a time</span>
        try {
<span class="fc" id="L124">            long now = System.currentTimeMillis();</span>

<span class="fc" id="L126">            Inmate existingInmate = inmatesDb.findExactlyOne(CLIENT_IDENTIFIER_INDEX, clientIdentifier);</span>
<span class="fc bfc" id="L127" title="All 2 branches covered.">            if (existingInmate == null) {</span>
                // if this is a new inmate, add them
<span class="fc" id="L129">                long releaseTime = now + sentenceDuration;</span>
<span class="fc" id="L130">                logger.logDebug(() -&gt; &quot;TheBrig: Putting away &quot; + clientIdentifier + &quot; for &quot; + sentenceDuration + &quot; milliseconds. Release time: &quot; + releaseTime + &quot;. Current time: &quot; + now);</span>
<span class="fc" id="L131">                Inmate newInmate = new Inmate(0L, clientIdentifier, releaseTime);</span>
<span class="fc" id="L132">                inmatesDb.write(newInmate);</span>
<span class="fc" id="L133">            } else {</span>
                // if this is an existing inmate continuing to attack us, just update their duration
<span class="fc" id="L135">                long releaseTime = existingInmate.getReleaseTime() + sentenceDuration;</span>
<span class="fc" id="L136">                logger.logDebug(() -&gt; &quot;TheBrig: Putting away &quot; + clientIdentifier + &quot; for &quot; + sentenceDuration + &quot; milliseconds. Release time: &quot; + releaseTime + &quot;. Current time: &quot; + now);</span>
<span class="fc" id="L137">                inmatesDb.write(new Inmate(existingInmate.getIndex(), existingInmate.getClientId(), releaseTime));</span>
            }
        } finally {
<span class="fc" id="L140">            lock.unlock();</span>
        }
<span class="fc" id="L142">        return true;</span>

    }

    @Override
    public boolean isInJail(String clientIdentifier) {
<span class="fc" id="L148">        lock.lock();</span>
        try {
<span class="fc bfc" id="L150" title="All 2 branches covered.">            return inmatesDb.findExactlyOne(CLIENT_IDENTIFIER_INDEX, clientIdentifier) != null;</span>
        } finally {
<span class="fc" id="L152">            lock.unlock();</span>
        }
    }

    @Override
    public List&lt;Inmate&gt; getInmates() {
<span class="fc" id="L158">        lock.lock();</span>
        try {
<span class="fc" id="L160">            return inmatesDb.values().stream().toList();</span>
        } finally {
<span class="fc" id="L162">            lock.unlock();</span>
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>