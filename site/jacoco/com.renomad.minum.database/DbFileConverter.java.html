<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DbFileConverter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">minum</a> &gt; <a href="index.source.html" class="el_package">com.renomad.minum.database</a> &gt; <span class="el_source">DbFileConverter.java</span></div><h1>DbFileConverter.java</h1><pre class="source lang-java linenums">package com.renomad.minum.database;

import com.renomad.minum.logging.ILogger;
import com.renomad.minum.state.Context;

import java.io.BufferedReader;
import java.io.FileReader;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.ArrayList;
import java.util.Comparator;
import java.util.List;
import java.util.stream.Stream;

import static com.renomad.minum.utils.Invariants.mustBeFalse;
import static java.nio.charset.StandardCharsets.US_ASCII;
import static java.nio.file.StandardOpenOption.*;

/**
 * This class exists to handle converting from one file/folder
 * style of database to another.
 */
final class DbFileConverter {

    private final Path dbDirectory;
    private final ILogger logger;
    private final DatabaseAppender databaseAppender;
    private final DatabaseConsolidator databaseConsolidator;

    /**
     * Construct a converter instance
     * @param context this is used for its constants, logger, and so on.
     * @param dbDirectory this is the specific directory for this database,
     *                    for example, the full path to the &quot;users&quot; database directory.
     */
<span class="fc" id="L37">    DbFileConverter(Context context, Path dbDirectory) throws IOException {</span>
<span class="fc" id="L38">        this.dbDirectory = dbDirectory;</span>
<span class="fc" id="L39">        this.logger = context.getLogger();</span>
<span class="fc" id="L40">        this.databaseAppender = new DatabaseAppender(dbDirectory, context);</span>
<span class="fc" id="L41">        this.databaseConsolidator = new DatabaseConsolidator(dbDirectory, context);</span>
<span class="fc" id="L42">    }</span>

    /**
     * convert a directory of database files from the old Db classic form to the DbEngine2 form.
     * The old form was one file per data item, the new form has append-only
     * data logs and consolidated files.
     */
    void convertClassicFolderStructureToDbEngine2Form() throws IOException {
<span class="fc" id="L50">        displayWarningConvertingClassicToDbEngine2();</span>
<span class="fc" id="L51">        try (var fileReader = new FileReader(dbDirectory.resolve(&quot;index.ddps&quot;).toFile(), US_ASCII)) {</span>
<span class="fc" id="L52">            try (BufferedReader br = new BufferedReader(fileReader)) {</span>
<span class="fc" id="L53">                String s = br.readLine();</span>
<span class="fc bfc" id="L54" title="All 2 branches covered.">                if (s == null) throw new DbException(&quot;index file for &quot; + dbDirectory + &quot; returned null when reading a line from it&quot;);</span>
<span class="fc" id="L55">                mustBeFalse(s.isBlank(), &quot;Unless something is terribly broken, we expect a numeric value here&quot;);</span>
            }
        }

<span class="fc" id="L59">        walkFilesAndConvertDbToDbEngine2(this.dbDirectory, this.logger);</span>
<span class="fc" id="L60">    }</span>



    private void displayWarningConvertingClassicToDbEngine2() {
<span class="fc" id="L65">        logger.logDebug(() -&gt; &quot;*****************************************************************&quot;);</span>
<span class="fc" id="L66">        logger.logDebug(() -&gt; &quot;*****************************************************************&quot;);</span>
<span class="fc" id="L67">        logger.logDebug(() -&gt; &quot;........&quot;);</span>
<span class="fc" id="L68">        logger.logDebug(() -&gt; &quot;About to convert database files from Db Classic to Db Engine 2&quot;);</span>
<span class="fc" id="L69">        logger.logDebug(() -&gt; &quot;........&quot;);</span>
<span class="fc" id="L70">        logger.logDebug(() -&gt; &quot;*****************************************************************&quot;);</span>
<span class="fc" id="L71">        logger.logDebug(() -&gt; &quot;*****************************************************************&quot;);</span>
<span class="fc" id="L72">    }</span>

    private void displayWarningConvertingDbEngine2ToClassic() {
<span class="fc" id="L75">        logger.logDebug(() -&gt; &quot;*****************************************************************&quot;);</span>
<span class="fc" id="L76">        logger.logDebug(() -&gt; &quot;*****************************************************************&quot;);</span>
<span class="fc" id="L77">        logger.logDebug(() -&gt; &quot;........&quot;);</span>
<span class="fc" id="L78">        logger.logDebug(() -&gt; &quot;About to convert database files from Db Engine2 to Db Classic&quot;);</span>
<span class="fc" id="L79">        logger.logDebug(() -&gt; &quot;........&quot;);</span>
<span class="fc" id="L80">        logger.logDebug(() -&gt; &quot;*****************************************************************&quot;);</span>
<span class="fc" id="L81">        logger.logDebug(() -&gt; &quot;*****************************************************************&quot;);</span>
<span class="fc" id="L82">    }</span>

    /**
     * walk through all the files in this directory, collecting
     * all regular files (non-subdirectories) except for index.ddps
     */
    static void walkFilesAndConvertDbToDbEngine2(Path dbDirectory, ILogger logger) throws IOException {
<span class="fc" id="L89">        List&lt;Path&gt; listOfFiles = getListOfFiles(dbDirectory);</span>

        // convert each file to the new database schema by appending it
        // to the append log, and then delete it
<span class="fc bfc" id="L93" title="All 2 branches covered.">        for (int i = 0; i &lt; listOfFiles.size(); i++) {</span>
<span class="fc" id="L94">            int percentCompletion = listOfFiles.size() / 100;</span>
<span class="fc bfc" id="L95" title="All 2 branches covered.">            if (i == percentCompletion) {</span>
<span class="fc" id="L96">                logger.logDebug(() -&gt; &quot;File converting is %d percent complete&quot;.formatted(percentCompletion));</span>
            }
<span class="fc" id="L98">            Path p = extractDataAndAppend(dbDirectory, logger, listOfFiles.get(i));</span>
<span class="fc" id="L99">            Files.delete(p);</span>
        }

        // at this point, after all the ordinary files have been removed, kill the index file
<span class="fc" id="L103">        Files.delete(dbDirectory.resolve(&quot;index.ddps&quot;));</span>
<span class="fc" id="L104">    }</span>

    /**
     * This method digs into the Db Classic file, checks everything is kosher, and
     * if so, appends it to the append-only log file which is part of DbEngine2
     */
    static Path extractDataAndAppend(Path dbDirectory, ILogger logger, Path fileToAnalyze) throws IOException {
<span class="fc" id="L111">        String fileContents = checkFileDetailsAreValid(fileToAnalyze, logger);</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">        if (!fileContents.isBlank()) {</span>
<span class="fc" id="L113">            Files.writeString(</span>
<span class="fc" id="L114">                    dbDirectory.resolve(&quot;currentAppendLog&quot;),</span>
<span class="fc" id="L115">                    &quot;UPDATE %s\n&quot;.formatted(fileContents), APPEND, CREATE);</span>
        }
<span class="fc" id="L117">        return fileToAnalyze;</span>
    }

    /**
     * Get the files that make up the file schema of Db Classic
     */
    private static List&lt;Path&gt; getListOfFiles(Path dbDirectory) {
        List&lt;Path&gt; listOfFiles;
<span class="fc" id="L125">        try (Stream&lt;Path&gt; fileStream = Files.list(dbDirectory)) {</span>
<span class="fc" id="L126">            listOfFiles = fileStream.filter(path -&gt;</span>
<span class="fc bfc" id="L127" title="All 2 branches covered.">                            Files.isRegularFile(path) &amp;&amp;</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">                                    path.getFileName().toString().endsWith(&quot;.ddps&quot;) &amp;&amp;</span>
<span class="fc bfc" id="L129" title="All 2 branches covered.">                                    !path.getFileName().toString().startsWith(&quot;index&quot;))</span>
<span class="fc" id="L130">                    .toList();</span>
<span class="fc" id="L131">        } catch (IOException ex) {</span>
<span class="fc" id="L132">            throw new DbException(&quot;Failed during the listing of files during conversion of db to db engine2&quot;, ex);</span>
<span class="fc" id="L133">        }</span>
<span class="fc" id="L134">        return listOfFiles;</span>
    }

    /**
     * This code inspects that the data in the file is valid
     * and returns the data. This method is called as part of
     * convert Db Classic to DbEngine2
     */
    static String checkFileDetailsAreValid(Path p, ILogger logger) throws IOException {
<span class="fc bfc" id="L143" title="All 2 branches covered.">        if (!Files.isRegularFile(p)) {</span>
<span class="fc" id="L144">            throw new DbException(&quot;At checkFileDetailsAreValid, path &quot; + p + &quot; is not a regular file&quot;);</span>
        }
<span class="fc" id="L146">        String fileName = p.getFileName().toString();</span>
<span class="fc" id="L147">        int startOfSuffixIndex = fileName.indexOf('.');</span>
<span class="fc" id="L148">        String fileContents = Files.readString(p);</span>
<span class="fc bfc" id="L149" title="All 2 branches covered.">        if (fileContents.isBlank()) {</span>
<span class="fc" id="L150">            logger.logDebug( () -&gt; fileName + &quot; file exists but empty, skipping&quot;);</span>
<span class="fc" id="L151">            return &quot;&quot;;</span>
        } else {
<span class="fc" id="L153">            return deserializeDataFromDbFile(fileName, startOfSuffixIndex, fileContents);</span>
        }
    }

    /**
     * While converting Db Classic files to DbEngine2, each data file will be inspected.
     * Here, we are looking at the contents of the files.
     */
    static String deserializeDataFromDbFile(String filename, int startOfSuffixIndex, String fileContents) {
<span class="fc" id="L162">        int fileNameIdentifier = Integer.parseInt(filename.substring(0, startOfSuffixIndex));</span>
<span class="fc" id="L163">        int indexOfFirstPipe = fileContents.indexOf('|');</span>
<span class="fc" id="L164">        String indexString = fileContents.substring(0, indexOfFirstPipe);</span>
<span class="fc" id="L165">        long index = Long.parseLong(indexString);</span>
<span class="fc bfc" id="L166" title="All 2 branches covered.">        if (index != fileNameIdentifier) {</span>
<span class="fc" id="L167">            throw new DbException( &quot;The filename (%s) must correspond to the index in its contents (%d)&quot;</span>
<span class="fc" id="L168">                    .formatted(filename, index));</span>
        }
<span class="fc" id="L170">        return fileContents;</span>
    }

    /**
     * Convert the folder/file structure.  From DbEngine2 format to Db classic.
     */
    void convertFolderStructureToDbClassic() throws IOException {
<span class="fc" id="L177">        displayWarningConvertingDbEngine2ToClassic();</span>

        // if there are any remnant items in the current append-only file, move them
        // to a new file
<span class="fc" id="L181">        databaseAppender.saveOffCurrentDataToReadyFolder();</span>

        // consolidate whatever files still exist in the append logs
<span class="fc" id="L184">        databaseConsolidator.consolidate();</span>

        // at this point, all the data is consolidated, in order, so we can step
        // through the data, creating new files, and finish up with an index.ddps
        // set to the proper value (i.e. one greater than the max index in the database)
<span class="fc" id="L189">        walkFilesAndConvertDbEngine2ToDbClassic(this.dbDirectory, this.logger);</span>
<span class="fc" id="L190">    }</span>

    /**
     * This is a pretty intricate method.  It basically steps through the consolidated
     * data files, writing each line to a new file.  It has to handle this through
     * multiple files and deleting files when finished, and closing file handles
     * appropriately when done with a file, and doing it in the proper order.
     */
    static void walkFilesAndConvertDbEngine2ToDbClassic(Path dbDirectory, ILogger logger) throws IOException {
        // get the list of consolidated data files
        List&lt;Path&gt; listOfFiles;
<span class="fc" id="L201">        try (Stream&lt;Path&gt; fileStream = Files.list(dbDirectory.resolve(&quot;consolidated_data&quot;))) {</span>
<span class="fc" id="L202">            listOfFiles = new ArrayList&lt;&gt;(fileStream.filter(Files::isRegularFile).toList());</span>
<span class="fc" id="L203">        } catch (IOException ex) {</span>
<span class="fc" id="L204">            throw new DbException(&quot;Failed during the listing of files during conversion of db engine2 to db classic&quot;, ex);</span>
<span class="fc" id="L205">        }</span>

        // sort the data in ascending order.  Files like &quot;1_to_10&quot; will come before &quot;11_to_20&quot;
<span class="fc" id="L208">        listOfFiles.sort(Comparator.comparing(x -&gt; {</span>
<span class="fc" id="L209">            String filename = x.getFileName().toString();</span>
<span class="fc" id="L210">            int indexOfFirstUnderscore = filename.indexOf('_');</span>
<span class="fc bfc" id="L211" title="All 2 branches covered.">            if (indexOfFirstUnderscore == -1) {</span>
<span class="fc" id="L212">                throw new DbException(&quot;Error: Failed to find first underscore in filename: &quot; + filename);</span>
            }
<span class="fc" id="L214">            String firstIndexNumberOfFile = filename.substring(0, indexOfFirstUnderscore);</span>
            try {
<span class="fc" id="L216">                return Long.parseLong(firstIndexNumberOfFile);</span>
<span class="fc" id="L217">            } catch (NumberFormatException ex) {</span>
<span class="fc" id="L218">                throw new DbException(&quot;Failed to convert first part of filename to a number: &quot; + filename);</span>
            }
        }));

        // initialize a variable to record the current maximum index value
<span class="fc" id="L223">        long currentMaxIndexValue = -1;</span>

        // initialize a variable to record the count of data items converted to Db Classic
<span class="fc" id="L226">        long countConvertedFiles = 0;</span>

        // convert each line of each file to its own file, per the needs of Db Classic
<span class="fc bfc" id="L229" title="All 2 branches covered.">        for (Path filePath : listOfFiles) {</span>
<span class="fc" id="L230">            try (BufferedReader reader = Files.newBufferedReader(filePath.toFile().toPath(), US_ASCII)) {</span>
                String line;
<span class="fc bfc" id="L232" title="All 2 branches covered.">                while ((line = reader.readLine()) != null) {</span>
<span class="fc" id="L233">                    int i = line.indexOf('|');</span>
<span class="fc bfc" id="L234" title="All 2 branches covered.">                    if (i == -1) {</span>
<span class="fc" id="L235">                        throw new DbException((&quot;Unable to convert a line - check for &quot; +</span>
<span class="fc" id="L236">                                &quot;corruption.  File: %s Data: %s&quot;).formatted(filePath, line));</span>
                    }
<span class="fc" id="L238">                    String indexNumberString = line.substring(0, i);</span>
                    long indexNumber;
                    try {
<span class="fc" id="L241">                        indexNumber = Long.parseLong(indexNumberString);</span>
<span class="fc" id="L242">                        currentMaxIndexValue = Math.max(indexNumber, currentMaxIndexValue);</span>
<span class="fc" id="L243">                    } catch (NumberFormatException ex) {</span>
<span class="fc" id="L244">                        throw new DbException((&quot;Unable to convert a line - check for &quot; +</span>
<span class="fc" id="L245">                                &quot;corruption.  File: %s Data: %s&quot;).formatted(filePath, line));</span>
<span class="fc" id="L246">                    }</span>
<span class="fc" id="L247">                    String dbFilename = indexNumber + &quot;.ddps&quot;;</span>
<span class="fc" id="L248">                    Path dbFullPath = dbDirectory.resolve(dbFilename);</span>
<span class="fc" id="L249">                    Files.writeString(dbFullPath, line, CREATE, WRITE);</span>
<span class="fc" id="L250">                    countConvertedFiles += 1;</span>
<span class="fc" id="L251">                    logAlongConversion(logger, countConvertedFiles, 1000);</span>
<span class="fc" id="L252">                }</span>
            }
            // now we've converted everything from this file, delete it.
<span class="fc" id="L255">            Files.delete(filePath);</span>
<span class="fc" id="L256">        }</span>

<span class="fc" id="L258">        deleteEmptyDbEngine2Directories(dbDirectory);</span>
<span class="fc" id="L259">        createNewIndexFile(dbDirectory, currentMaxIndexValue);</span>
<span class="fc" id="L260">    }</span>

    /**
     * This small helper method will create an `index.ddps` file with the correct value
     * for use with Db classic.  It determines the correct value by having calculated the
     * maximum-value-seen throughout the conversion process.
     */
    static void createNewIndexFile(Path dbDirectory, long currentMaxIndexValue) {
        // create an index.ddps with a value set to the current max, plus one
        try {
<span class="fc" id="L270">            Files.writeString(dbDirectory.resolve(&quot;index.ddps&quot;), String.valueOf(currentMaxIndexValue + 1), CREATE_NEW);</span>
<span class="fc" id="L271">        } catch (IOException ex) {</span>
<span class="fc" id="L272">            throw new DbException(&quot;Failed to create an index.ddps file&quot;, ex);</span>
<span class="fc" id="L273">        }</span>
<span class="fc" id="L274">    }</span>

    /**
     * This method is called after conversion to Db classic, at which point these directories
     * will be empty.
     */
    static void deleteEmptyDbEngine2Directories(Path dbDirectory) {
        try {
<span class="fc" id="L282">            Files.deleteIfExists(dbDirectory.resolve(&quot;consolidated_data&quot;));</span>
<span class="fc" id="L283">            Files.deleteIfExists(dbDirectory.resolve(&quot;currentAppendLog&quot;));</span>
<span class="fc" id="L284">            Files.deleteIfExists(dbDirectory.resolve(&quot;append_logs&quot;));</span>
<span class="fc" id="L285">        } catch (IOException ex) {</span>
<span class="fc" id="L286">            throw new DbException(&quot;Failed to delete one of the DbEngine2 files&quot;, ex);</span>
<span class="fc" id="L287">        }</span>
<span class="fc" id="L288">    }</span>

    /**
     * A helper to choose when to output logging statements during the conversion
     * of files from one database file format to another.
     * @param countConvertedFilesModulo modulo this number at which a log statement will be output.
     */
    static void logAlongConversion(ILogger logger, long countConvertedFiles, int countConvertedFilesModulo) {
<span class="fc bfc" id="L296" title="All 2 branches covered.">        if (countConvertedFiles % countConvertedFilesModulo == 0) {</span>
<span class="fc" id="L297">            logger.logDebug(() -&gt; &quot;DbFileConverter has converted %d files to Db Classic form&quot;</span>
<span class="fc" id="L298">                    .formatted(countConvertedFiles));</span>
        }
<span class="fc" id="L300">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>